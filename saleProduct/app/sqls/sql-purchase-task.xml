<?xml version="1.0" encoding="UTF-8"?>
<properties>
    <entry key="sql_purchase_task_list">
        select spt.* ,
           (select name from sc_user where login_id = spt.created_by) as EXECUTOR_NAME
         from sc_purchase_task spt 
         where 1=1
          {@ and spt.task_code = '#taskCode#'}
         {@ #$purchaseTask_view: and 1=0# }
         order by spt.id desc
    </entry>
    
     <entry key="sql_purchase_task_insert">
		INSERT INTO sc_purchase_task 
			(
			TASK_CODE, 
			CREATED_BY, 
			CREATED_TIME, 
			LAST_UPDATED_BY, 
			LAST_UPDATED_TIME, 
			MEMO, 
			STATUS
			)
			VALUES
			( 
			'{@#taskCode#}', 
			'{@#loginId#}', 
			NOW(), 
			'{@#loginId#}', 
			NOW(), 
			'{@#memo#}', 
			'1'
			)
    </entry>
    
    <entry key="sql_purchase_task_update">
		UPDATE sc_purchase_task 
			SET
			TASK_CODE = '{@#taskCode#}' , 
			LAST_UPDATED_BY = '{@#loginId#}' , 
			LAST_UPDATED_TIME = NOW() , 
			MEMO = '{@#memo#}' 
			WHERE
			ID = '{@#id#}' 
    </entry>
    
    <entry key="sql_purchase_task_updateStatus">
        update sc_purchase_task set status = '{@#status#}' where id = '{@#taskId#}' and (status = '1' or status is null )
    </entry>
    
    
    <entry key="sql_purchase_task_getById">
        select 
           spt.*,
           (select name from sc_user where login_id = spt.created_by) as EXECUTOR_NAME
         from sc_purchase_task spt 
        where spt.id = '{@#taskId#}'
    </entry>
    
    
     <entry key="sql_purchase_task_product_insert">
        
		INSERT INTO sc_purchase_task_products 
			(TASK_ID, 
			PRODUCT_ID
			)
			VALUES
			('{@#taskId#}', 
			'{@#productId#}'
			)

    </entry>
    
    <!-- and sppd.executor = '{@#Evn.loginId#}' -->
    <entry key="sql_purchase_task_product_list">
		SELECT DISTINCT  
			sppd.* ,
			srp.name as TITLE,
			srp.IMAGE_URL,
			(select name from sc_supplier where id = sppd.PROVIDOR ) as PROVIDOR_NAME,
			(select name from sc_user where login_id = sppd.executor ) as EXECUTOR_NAME,
			( sppd.PLAN_NUM - IFNULL(sppd.QUALIFIED_PRODUCTS_NUM,0) ) as SUPPIERABLE_NUM
		FROM 
		sc_purchase_task_products sptp,
		sc_purchase_plan_details sppd 
		left join sc_real_product srp
		on sppd.SKU = srp.real_sku
		WHERE 1=1 
		    and sptp.product_id = sppd.id
		    and sptp.task_id = '{@#taskId#}'
    </entry>
    
    <entry key="sql_purchase_task_product_selectable">
    <![CDATA[
    	SELECT DISTINCT  
			sppd.* ,
			srp.name as TITLE,
			srp.IMAGE_URL,
			(select name from sc_supplier where id = sppd.PROVIDOR ) as PROVIDOR_NAME,
			(select name from sc_user where login_id = sppd.executor ) as EXECUTOR_NAME,
			( sppd.PLAN_NUM - IFNULL(sppd.QUALIFIED_PRODUCTS_NUM,0) ) as SUPPIERABLE_NUM
		FROM sc_purchase_plan_details sppd 
		left join sc_real_product srp
		on sppd.SKU = srp.real_sku
		WHERE 1=1 
			and sppd.status >=45
			and sppd.executor = '{@#Evn.loginId#}'
			and sppd.id not in (
				select product_id from sc_purchase_task_products where task_id = '{@#taskId#}'
			)
			and ( sppd.PLAN_NUM - IFNULL(sppd.QUALIFIED_PRODUCTS_NUM,0) ) > 0
	]]>
    </entry>
    
    <entry key="sql_purchase_task_productsForPrint">
		SELECT DISTINCT  
			sppd.* ,
			srp.name as TITLE,
			srp.IMAGE_URL,
			(select name from sc_supplier where id = sppd.PROVIDOR ) as PROVIDOR_NAME,
			(select name from sc_user where login_id = sppd.executor ) as EXECUTOR_NAME,
			( sppd.PLAN_NUM - IFNULL(sppd.QUALIFIED_PRODUCTS_NUM,0) ) as SUPPIERABLE_NUM
		FROM 
		sc_purchase_task_products sptp,
		sc_purchase_plan_details sppd 
		left join sc_real_product srp
		on sppd.SKU = srp.real_sku
		WHERE 1=1 
		    and sptp.product_id = sppd.id
		    and sptp.task_id = '{@#taskId#}'
			and sppd.executor = '{@#Evn.loginId#}'
			and ( sppd.PLAN_NUM - IFNULL(sppd.QUALIFIED_PRODUCTS_NUM,0) ) > 0
   </entry>
</properties>